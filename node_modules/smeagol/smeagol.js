// Smeagl, nodeJS crawler to get content in HTML pages


module.paths.unshift('/usr/local/lib/node_modules/');

var fs = require('fs'),
	jsdom = require('jsdom');

var settings,
	crawled,
	toCrawl,
	result;

exports.configure = function(config){
	settings = config,
	crawled = [],
	toCrawl = [],
	result = {};
}

exports.crawl = function(obj){
	jsdom.env(
	  obj.uri,
	  ['http://code.jquery.com/jquery.js'],
	  function (errors, window) {
	    
	    /* Add to crawled urls */
	    crawled.push(obj.uri);

	    /* Verify url pattern */
		for(var i in settings['patterns']){
			var page_properties = settings['patterns'][i],
				re = new RegExp('^' + i + '$','gi');
			
			if(re.exec(obj.uri)){
				var contents = settings['patterns'][i]['find'];

				console.log('Pattern casou!')

				/* Get content in pattern.find */
				for(var find in contents){
					result[find] = eval('window.$'+contents[find]);
				}

			}
		}
		settings.callback(result);
		return result;
	  }
	);

	
}

